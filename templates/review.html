<!doctype html>
<html>
  <head>
    <title>Review Submissions</title>
    <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.1/dist/pocketbase.umd.js"></script>
    <style>
      body {
        font-family: sans-serif;
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
      }
      .login-form {
        max-width: 400px;
        margin: 50px auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .login-form input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        box-sizing: border-box;
      }
      .login-form button {
        width: 100%;
        padding: 10px;
        background: #2196f3;
        color: white;
        border: none;
        cursor: pointer;
      }
      .error {
        color: #f44336;
        margin: 10px 0;
      }
      #review-content {
        display: none;
      }
      .group {
        margin-bottom: 30px;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
      }
      .group h2 {
        margin-top: 0;
        text-transform: uppercase;
      }
      .submission {
        background: #f9f9f9;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .submission-text {
        white-space: pre-wrap;
        margin: 10px 0;
      }
      .meta {
        font-size: 12px;
        color: #666;
      }
      button {
        padding: 5px 10px;
        margin-right: 5px;
        cursor: pointer;
      }
      .btn-approved {
        background: #4caf50;
        color: white;
        border: none;
      }
      .btn-hidden {
        background: #ff9800;
        color: white;
        border: none;
      }
      .btn-deleted {
        background: #f44336;
        color: white;
        border: none;
      }
      .btn-new {
        background: #2196f3;
        color: white;
        border: none;
      }
      .btn-done {
        background: #9c27b0;
        color: white;
        border: none;
      }
      .group h2 {
        user-select: none;
      }
      .notes {
        background: #fff3cd;
        padding: 10px;
        margin: 10px 0;
        border-radius: 3px;
        border-left: 3px solid #ffc107;
      }
    </style>
  </head>
  <body>
    <div id="login-form" class="login-form">
      <h2>Login to Review</h2>
      <div id="error" class="error"></div>
      <form onsubmit="login(); return false;">
        <input type="email" id="email" placeholder="Email" required />
        <input type="password" id="password" placeholder="Password" required />
        <button type="submit">Login</button>
      </form>
    </div>

    <div id="review-content">
      <h1>Review Submissions</h1>
      <p><button onclick="logout()">Logout</button></p>
      <div id="submissions"></div>
    </div>

    <script>
      const pb = new PocketBase(window.location.origin);

      async function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const errorDiv = document.getElementById("error");

        try {
          await pb.collection("_superusers").authWithPassword(email, password);
          errorDiv.textContent = "";
          showReviewContent();
        } catch (err) {
          errorDiv.textContent =
            "Login failed: " + (err.message || "Invalid credentials");
        }
      }

      async function logout() {
        // Unsubscribe from realtime updates
        pb.collection("submissions").unsubscribe();
        pb.authStore.clear();
        document.getElementById("login-form").style.display = "block";
        document.getElementById("review-content").style.display = "none";
      }

      async function updateStatus(id, status) {
        try {
          await pb.send("/api/submissions/" + id + "/status", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: pb.authStore.token,
            },
            body: JSON.stringify({ status: status }),
          });
          loadSubmissions();
        } catch (err) {
          alert("Failed to update: " + err.message);
        }
      }

      async function loadSubmissions() {
        // Save current collapsed state
        const collapsedState = {};
        ["approved", "new", "done", "hidden", "deleted"].forEach((status) => {
          const groupId = "group-" + status;
          const group = document.getElementById(groupId);
          if (group) {
            collapsedState[status] = group.style.display === "none";
          }
        });

        try {
          const records = await pb.collection("submissions").getFullList({
            sort: "-created",
          });

          const grouped = {
            new: [],
            approved: [],
            hidden: [],
            deleted: [],
            done: [],
          };

          records.forEach((record) => {
            if (grouped[record.status]) {
              grouped[record.status].push(record);
            }
          });

          let html = "";
          ["approved", "new", "done", "hidden", "deleted"].forEach((status) => {
            const groupId = "group-" + status;
            html += '<div class="group">';
            html +=
              "<h2 onclick=\"toggleGroup('" +
              groupId +
              '\')" style="cursor: pointer;">';
            html += '<span id="' + groupId + '-icon">[-]</span> ';
            html += status.toUpperCase() + " (" + grouped[status].length + ")";
            html += "</h2>";
            html += '<div id="' + groupId + '">';

            if (grouped[status].length === 0) {
              html += "<p>No submissions</p>";
            } else {
              grouped[status].forEach((record) => {
                html +=
                  '<div class="submission" id="submission-' + record.id + '">';
                html += '<div class="view-mode">';
                const text = linkifyUrls(escapeHtml(record.text));
                html += '<div class="submission-text">' + text + "</div>";
                if (record.notes) {
                  html +=
                    '<div class="notes"><strong>Notes:</strong> ' +
                    escapeHtml(record.notes) +
                    "</div>";
                }
                html +=
                  '<div class="meta">Created: ' + record.created + "</div>";
                html += "<div>";
                html +=
                  '<button class="btn-approved" onclick="updateStatus(\'' +
                  record.id +
                  "', 'approved')\">Approved</button>";
                html +=
                  '<button class="btn-new" onclick="updateStatus(\'' +
                  record.id +
                  "', 'new')\">New</button>";
                html +=
                  '<button class="btn-done" onclick="updateStatus(\'' +
                  record.id +
                  "', 'done')\">Done</button>";
                html +=
                  '<button class="btn-hidden" onclick="updateStatus(\'' +
                  record.id +
                  "', 'hidden')\">Hidden</button>";
                html +=
                  '<button class="btn-deleted" onclick="updateStatus(\'' +
                  record.id +
                  "', 'deleted')\">Deleted</button>";
                html +=
                  " <button onclick=\"editSubmission('" +
                  record.id +
                  "')\">Edit</button>";
                html += "</div></div>";

                // Edit mode (hidden by default)
                html += '<div class="edit-mode" style="display: none;">';
                html +=
                  '<textarea id="edit-text-' +
                  record.id +
                  '" style="width: 100%; min-height: 100px;">' +
                  escapeHtml(record.text) +
                  "</textarea>";
                html +=
                  '<label style="display: block; margin-top: 10px;"><strong>Notes:</strong></label>';
                html +=
                  '<textarea id="edit-notes-' +
                  record.id +
                  '" style="width: 100%; min-height: 60px;">' +
                  escapeHtml(record.notes || "") +
                  "</textarea>";
                html += '<div style="margin-top: 10px;">';
                html +=
                  '<button class="btn-approved" onclick="saveSubmission(\'' +
                  record.id +
                  "')\">Save</button> ";
                html +=
                  "<button onclick=\"cancelEdit('" +
                  record.id +
                  "')\">Cancel</button>";
                html += "</div></div>";

                html += "</div>";
              });
            }
            html += "</div></div>";
          });

          document.getElementById("submissions").innerHTML = html;

          // Restore previous collapsed state or use defaults
          ["approved", "new", "done", "hidden", "deleted"].forEach((status) => {
            const groupId = "group-" + status;
            const group = document.getElementById(groupId);
            const icon = document.getElementById(groupId + "-icon");
            if (group && icon) {
              // If we have saved state, use it; otherwise use defaults
              const shouldCollapse = collapsedState.hasOwnProperty(status)
                ? collapsedState[status]
                : ["done", "hidden", "deleted"].includes(status);

              if (shouldCollapse) {
                group.style.display = "none";
                icon.textContent = "[+]";
              } else {
                group.style.display = "block";
                icon.textContent = "[-]";
              }
            }
          });
        } catch (err) {
          console.error("Failed to load submissions:", err);
        }
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function linkifyUrls(text) {
        const urlPattern = /(https?:\/\/[^\s]+)/g;
        return text.replace(
          urlPattern,
          '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>',
        );
      }

      function editSubmission(id) {
        const submission = document.getElementById("submission-" + id);
        submission.querySelector(".view-mode").style.display = "none";
        submission.querySelector(".edit-mode").style.display = "block";
      }

      function cancelEdit(id) {
        const submission = document.getElementById("submission-" + id);
        submission.querySelector(".view-mode").style.display = "block";
        submission.querySelector(".edit-mode").style.display = "none";
      }

      async function saveSubmission(id) {
        const text = document.getElementById("edit-text-" + id).value;
        const notes = document.getElementById("edit-notes-" + id).value;

        try {
          await pb.collection("submissions").update(id, {
            text: text,
            notes: notes,
          });
          cancelEdit(id);
          loadSubmissions();
        } catch (err) {
          alert("Failed to save: " + err.message);
        }
      }

      function toggleGroup(groupId) {
        const group = document.getElementById(groupId);
        const icon = document.getElementById(groupId + "-icon");
        if (group.style.display === "none") {
          group.style.display = "block";
          icon.textContent = "[-]";
        } else {
          group.style.display = "none";
          icon.textContent = "[+]";
        }
      }

      async function showReviewContent() {
        document.getElementById("login-form").style.display = "none";
        document.getElementById("review-content").style.display = "block";
        await loadSubmissions();

        // Subscribe to realtime updates
        pb.collection("submissions").subscribe("*", function (e) {
          console.log("Realtime event:", e.action);
          // Reload submissions when any change occurs
          loadSubmissions();
        });
      }

      // Check if already logged in
      if (pb.authStore.isValid) {
        showReviewContent();
      }
    </script>
  </body>
</html>
